pipeline:
  build:
    image: alpine:3.6
    commands:
      - apk --update add docker
      - "export DOCKER_HOST=unix:///var/run/host.sock"
      - docker build -t registry.dryusdan.fr/dryusdan/cachethq .
      - docker push registry.dryusdan.fr/dryusdan/cachethq
    secrets: [ DOCKER_USERNAME, DOCKER_PASSWORD ]
    volumes:
      - /var/run/docker.sock:/var/run/host.sock:ro
      - /home/docker/.docker:/docker/.docker/
  
  push:
    image: alpine:3.6
    commands:
      - apk --update add docker
      - "export DOCKER_HOST=unix:///var/run/host.sock"
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD registry.dryusdan.fr
      - docker push registry.dryusdan.fr/dryusdan/cachethq
      - docker push dryusdan/cachethq
    secrets: [ DOCKER_USERNAME, DOCKER_PASSWORD ]
    volumes:
      - /var/run/docker.sock:/var/run/host.sock:ro
      - /home/docker/.docker:/docker/.docker/

